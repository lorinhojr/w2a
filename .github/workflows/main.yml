name: Fabrica SAAS
on:
  repository_dispatch:
    types: [build_event]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Personalizar Projeto (SED)
        run: |
          # 1. Troca o Nome do App
          sed -i "s/NOME_DINAMICO/${{ github.event.client_payload.app_name }}/g" app/src/main/res/values/strings.xml
          
          # 2. Troca o Package no Manifest (Apenas no nome da Activity)
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/src/main/AndroidManifest.xml
          
          # 3. Troca o Package no Gradle (O que corrige o erro do AAB)
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/build.gradle.kts
          
          # 4. Troca o Package no código Java
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/src/main/java/com/meuapp/jogo/MainActivity.java
          
          # 5. Troca o Package no namespace do build.gradle.kts (crucial para AAB)
          sed -i "s/namespace \"PACOTE_DINAMICO\"/namespace \"${{ github.event.client_payload.package_name }}\"/g" app/build.gradle.kts
          
          # Mostra o conteúdo atualizado para debug
          echo "=== AndroidManifest.xml após atualização ==="
          cat app/src/main/AndroidManifest.xml
          
          echo "=== build.gradle.kts após atualização ==="
          cat app/build.gradle.kts
          
          echo "=== MainActivity.java após atualização ==="
          cat app/src/main/java/com/meuapp/jogo/MainActivity.java

      - name: Download e Troca do Ícone
        run: |
          echo "Tentando baixar ícone..."
          # Tenta baixar o ícone. Se falhar, o '|| true' garante que o robô não pare.
          curl -A "Mozilla/5.0" -L "${{ github.event.client_payload.icon_url }}" -o icone_usuario.png || true
          
          if [ -f icone_usuario.png ] && [ $(stat -c%s icone_usuario.png) -gt 0 ]; then
            echo "Ícone baixado com sucesso. Aplicando em todas as densidades..."
            find app/src/main/res/mipmap-* -name "ic_launcher.png" -exec cp icone_usuario.png {} \;
            find app/src/main/res/mipmap-* -name "ic_launcher_round.png" -exec cp icone_usuario.png {} \;
            echo "Ícone personalizado aplicado com sucesso!"
          else
            echo "Falha ao baixar ícone ou link inválido. Mantendo ícone padrão do molde."
          fi
          
          # Mostrar os ícones atualizados para debug
          echo "=== Ícones disponíveis após atualização ==="
          find app/src/main/res -name "ic_launcher*.png" -exec ls -la {} \;

      - name: Limpar e Extrair Projeto do Jogo
        run: |
          # 1. Garante que a pasta assets/www existe
          mkdir -p app/src/main/assets/www
          
          # 2. Limpa a pasta se já existir conteúdo
          rm -rf app/src/main/assets/www/*
          
          # 3. Baixa o ZIP do jogo (com fallback para URL padrão se necessário)
          if [ -n "${{ github.event.client_payload.zip_url }}" ]; then
            echo "Baixando jogo da URL: ${{ github.event.client_payload.zip_url }}"
            curl -L "${{ github.event.client_payload.zip_url }}" -o jogo.zip
          else
            echo "URL do jogo não fornecida. Usando conteúdo de exemplo."
            # Criar um index.html de exemplo
            mkdir -p app/src/main/assets/www
            echo "<html><body><h1>Jogo de Exemplo</h1><p>Este é um jogo de exemplo.</p></body></html>" > app/src/main/assets/www/index.html
          fi
          
          # 4. Extrai apenas se o arquivo zip existir
          if [ -f "jogo.zip" ]; then
            echo "Extraindo conteúdo do jogo..."
            unzip -o jogo.zip -d app/src/main/assets/www/
            
            # 5. Verifica se o index.html foi extraído corretamente
            if [ ! -f "app/src/main/assets/www/index.html" ]; then
              echo "AVISO: index.html não encontrado no ZIP. Verificando estrutura do projeto..."
              # Procurar por arquivos HTML ou JS que podem ser o ponto de entrada
              find app/src/main/assets/www/ -name "*.html" -o -name "*.htm" -o -name "*.js"
              
              # Se encontrar um arquivo HTML, renomear para index.html
              if [ -f "app/src/main/assets/www/index.htm" ]; then
                mv app/src/main/assets/www/index.htm app/src/main/assets/www/index.html
                echo "index.htm renomeado para index.html"
              elif [ -f "app/src/main/assets/www/main.html" ]; then
                mv app/src/main/assets/www/main.html app/src/main/assets/www/index.html
                echo "main.html renomeado para index.html"
              elif [ -f "app/src/main/assets/www/index.php" ]; then
                mv app/src/main/assets/www/index.php app/src/main/assets/www/index.html
                echo "index.php renomeado para index.html (modo compatibilidade PHP)"
              fi
            fi
          fi
          
          # 6. Debug: Mostra o conteúdo da pasta assets/www
          echo "=== Conteúdo da pasta assets/www após extração ==="
          ls -laR app/src/main/assets/www/

      - name: Dar permissão ao Gradle
        run: chmod +x gradlew

      - name: Configurar keystore para assinatura
        run: |
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 --decode > app/keystore.jks
          echo "Keystore configurado com sucesso"

      - name: Compilar APK e AAB (Release)
        run: ./gradlew assembleRelease bundleRelease --stacktrace --info
        env:
          ORG_GRADLE_PROJECT_storePassword: ${{ secrets.KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_keyPassword: ${{ secrets.KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_keyAlias: ${{ secrets.ALIAS }}
          ORG_GRADLE_PROJECT_storeFile: keystore.jks

      - name: Verificar se os arquivos foram gerados
        run: |
          echo "=== Verificando arquivos gerados ==="
          echo "APK Debug:"
          ls -la app/build/outputs/apk/debug/
          echo "APK Release:"
          ls -la app/build/outputs/apk/release/
          echo "AAB Release:"
          ls -la app/build/outputs/bundle/release/

      - name: Assinar Arquivos
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/release/
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        id: sign_app

      - name: Upload APK Assinado
        uses: actions/upload-artifact@v4
        with:
          name: APK_${{ github.event.client_payload.app_id }}
          path: ${{ steps.sign_app.outputs.signedReleaseFile }}

      - name: Upload AAB para Play Store
        uses: actions/upload-artifact@v4
        with:
          name: AAB_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/bundle/release/*.aab

      # Passo opcional para notificar o sistema principal sobre a conclusão do build
      - name: Notificar Sistema Principal
        if: success()
        run: |
          # Obter nome do arquivo AAB
          AAB_FILE=$(ls app/build/outputs/bundle/release/*.aab | xargs basename)
          
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
          -H "Content-Type: application/json" \
          -d '{
            "status": "success",
            "app_id": "${{ github.event.client_payload.app_id }}",
            "apk_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts?name=APK_${{ github.event.client_payload.app_id }}",
            "aab_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts?name=AAB_${{ github.event.client_payload.app_id }}",
            "artifact_names": {
              "apk": "APK_${{ github.event.client_payload.app_id }}",
              "aab": "AAB_${{ github.event.client_payload.app_id }}"
            }
          }'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Passo para lidar com falhas
      - name: Notificar Falha
        if: failure()
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
          -H "Content-Type: application/json" \
          -d '{
            "status": "error",
            "app_id": "${{ github.event.client_payload.app_id }}",
            "error": "Falha no processo de build - verifique os logs para detalhes",
            "logs_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
