name: W2A Builder

on:
  repository_dispatch:
    types: [build_event]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ORG_GRADLE_PROJECT_storePassword: ${{ secrets.KEY_PASSWORD || 'android' }}
      ORG_GRADLE_PROJECT_keyPassword: ${{ secrets.KEY_PASSWORD || 'android' }}
      ORG_GRADLE_PROJECT_keyAlias: ${{ secrets.ALIAS || 'androiddebugkey' }}

    steps:
      - name: Personalização TOTAL (igual Construct)
        run: |
          PKG="${{ github.event.client_payload.package_name }}"
          APP_NAME="${{ github.event.client_payload.app_name }}"
      
          PKG_PATH=$(echo "$PKG" | tr '.' '/')
      
          echo "Package: $PKG"
          echo "Path: $PKG_PATH"
      
          # ===== STRINGS =====
          sed -i "s/NOME_DINAMICO/$APP_NAME/g" app/src/main/res/values/strings.xml
      
          # ===== MANIFEST =====
          sed -i "s/package=\"[^\"]*\"/package=\"$PKG\"/g" app/src/main/AndroidManifest.xml
      
          # ===== GRADLE =====
          sed -i "s/namespace = \".*\"/namespace = \"$PKG\"/g" app/build.gradle.kts
          sed -i "s/applicationId = \".*\"/applicationId = \"$PKG\"/g" app/build.gradle.kts
      
          # ===== JAVA =====
          OLD_DIR=$(find app/src/main/java -name MainActivity.java | sed 's|/MainActivity.java||')
      
          mkdir -p app/src/main/java/$PKG_PATH
          mv $OLD_DIR/MainActivity.java app/src/main/java/$PKG_PATH/
      
          sed -i "s/^package .*/package $PKG;/" app/src/main/java/$PKG_PATH/MainActivity.java
      
          rm -rf app/src/main/java/com || true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Configurar Keystore
        run: |
          if [ -f app/chave1.jks ]; then
            echo "ORG_GRADLE_PROJECT_storeFile=chave1.jks" >> $GITHUB_ENV
          else
            keytool -genkeypair -v \
              -keystore app/keystore.jks \
              -alias androiddebugkey \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Android Debug, O=Android, C=US"
            echo "ORG_GRADLE_PROJECT_storeFile=keystore.jks" >> $GITHUB_ENV
          fi

      - name: Personalizar Projeto
        run: |
          sed -i "s/NOME_DINAMICO/${{ github.event.client_payload.app_name }}/g" app/src/main/res/values/strings.xml
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/src/main/AndroidManifest.xml
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/build.gradle.kts
          find app/src/main/java -type f -exec sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" {} \; || true

      # =========================
      # ÍCONE (WEBP – SEM ADAPTIVE ICON)
      # =========================
      - name: Download e Aplicação do Ícone
        run: |
          echo "=== BAIXANDO ÍCONE ==="
      
          curl -L \
            -H "User-Agent: Mozilla/5.0" \
            --fail \
            "${{ github.event.client_payload.icon_url }}" \
            -o ic_launcher.webp
      
          echo "=== SUBSTITUINDO ÍCONES ==="
      
          for dir in mdpi hdpi xhdpi xxhdpi xxxhdpi; do
            BASE="app/src/main/res/mipmap-$dir"
      
            [ -f "$BASE/ic_launcher.webp" ] && cp ic_launcher.webp "$BASE/ic_launcher.webp"
            [ -f "$BASE/ic_launcher_round.webp" ] && cp ic_launcher.webp "$BASE/ic_launcher_round.webp"
          done

      - name: Extrair jogo
        run: |
          mkdir -p app/src/main/assets/www
          rm -rf app/src/main/assets/www/*
          curl -L "${{ github.event.client_payload.zip_url }}" -o jogo.zip
          unzip -o jogo.zip -d app/src/main/assets/www/
          if [ ! -f app/src/main/assets/www/index.html ]; then
            echo "<h1>Erro: index.html não encontrado</h1>" > app/src/main/assets/www/index.html
          fi

      - name: Permissão Gradle
        run: chmod +x gradlew

      - name: Compilar
        run: |
          ./gradlew clean
          ./gradlew assembleRelease bundleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: APK_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/apk/release/*.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: AAB_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/bundle/release/*.aab
