name: Fabrica SAAS

on:
  repository_dispatch:
    types: [build_event]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ORG_GRADLE_PROJECT_storePassword: ${{ secrets.KEY_PASSWORD || 'android' }}
      ORG_GRADLE_PROJECT_keyPassword: ${{ secrets.KEY_PASSWORD || 'android' }}
      ORG_GRADLE_PROJECT_keyAlias: ${{ secrets.ALIAS || 'androiddebugkey' }}

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # =========================
      # KEYSTORE (REPO OU DEBUG)
      # =========================
      - name: Configurar Keystore
        run: |
          echo "=== CONFIGURANDO KEYSTORE ==="

          if [ -f app/chave1.jks ]; then
            echo "Keystore do repositório encontrado"
            echo "ORG_GRADLE_PROJECT_storeFile=chave1.jks" >> $GITHUB_ENV
          else
            echo "Criando keystore debug"
            keytool -genkeypair -v \
              -keystore app/keystore.jks \
              -alias androiddebugkey \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Android Debug, O=Android, C=US"

            echo "ORG_GRADLE_PROJECT_storeFile=keystore.jks" >> $GITHUB_ENV
          fi

      # =========================
      # PERSONALIZAÇÃO
      # =========================
      - name: Personalizar Projeto
        run: |
          sed -i "s/NOME_DINAMICO/${{ github.event.client_payload.app_name }}/g" app/src/main/res/values/strings.xml
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/src/main/AndroidManifest.xml
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/build.gradle.kts

          find app/src/main/java -type f -exec sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" {} \; || true

      # =========================
      # ÍCONE
      # =========================
      - name: Download e Troca do Ícone
        run: |
          echo "=== BAIXANDO ÍCONE ==="
          echo "URL do ícone: ${{ github.event.client_payload.icon_url }}"
      
          # Baixa o ícone GARANTINDO que seja imagem
          curl -L \
            -H "User-Agent: Mozilla/5.0" \
            -H "Accept: image/*" \
            --fail \
            "${{ github.event.client_payload.icon_url }}" \
            -o icone_usuario.png
      
          echo "=== VALIDANDO ÍCONE ==="
          file icone_usuario.png
      
          if file icone_usuario.png | grep -qi "image"; then
            echo "Ícone válido. Aplicando..."
      
            # Substitui apenas mipmaps corretos (PNG)
            for dir in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
              cp icone_usuario.png app/src/main/res/$dir/ic_launcher.png
              cp icone_usuario.png app/src/main/res/$dir/ic_launcher_round.png
            done
      
            echo "Ícone aplicado com sucesso."
          else
            echo "❌ Arquivo baixado NÃO é imagem. Mantendo ícone padrão."
            exit 0
          fi


      # =========================
      # JOGO
      # =========================
      - name: Extrair Jogo
        run: |
          mkdir -p app/src/main/assets/www
          rm -rf app/src/main/assets/www/*

          curl -L "${{ github.event.client_payload.zip_url }}" -o jogo.zip
          unzip -o jogo.zip -d app/src/main/assets/www/

          if [ ! -f app/src/main/assets/www/index.html ]; then
            echo "<h1>Jogo carregado</h1>" > app/src/main/assets/www/index.html
          fi

      - name: Permissão Gradle
        run: chmod +x gradlew

      # =========================
      # BUILD (ASSINADO PELO GRADLE)
      # =========================
      - name: Build APK e AAB
        run: |
          ./gradlew clean
          ./gradlew assembleRelease bundleRelease

      # =========================
      # UPLOAD
      # =========================
      - name: Upload APK Release
        uses: actions/upload-artifact@v4
        with:
          name: APK_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/apk/release/*.apk

      - name: Upload AAB Release
        uses: actions/upload-artifact@v4
        with:
          name: AAB_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/bundle/release/*.aab
