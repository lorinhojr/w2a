name: W2A Builder

on:
  repository_dispatch:
    types: [build_event]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ORG_GRADLE_PROJECT_storePassword: ${{ secrets.KEY_PASSWORD || 'android' }}
      ORG_GRADLE_PROJECT_keyPassword: ${{ secrets.KEY_PASSWORD || 'android' }}
      ORG_GRADLE_PROJECT_keyAlias: ${{ secrets.ALIAS || 'androiddebugkey' }}

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Personalizar Projeto (Dinâmico)
        run: |
          PKG="${{ github.event.client_payload.package_name }}"
          APP_NAME="${{ github.event.client_payload.app_name }}"
          
          echo "================================"
          echo "INICIANDO PERSONALIZAÇÃO"
          echo "Package: $PKG"
          echo "App Name: $APP_NAME"
          echo "================================"
          
          PKG_PATH=$(echo "$PKG" | tr '.' '/')
          
          # ===== STRINGS =====
          if [ -f "app/src/main/res/values/strings.xml" ]; then
            sed -i "s/NOME_DINAMICO/$APP_NAME/g" app/src/main/res/values/strings.xml
          fi
          
          # ===== MANIFEST =====
          if [ -f "app/src/main/AndroidManifest.xml" ]; then
            sed -i "s/PACOTE_DINAMICO/$PKG/g" app/src/main/AndroidManifest.xml
            # Remove package="..." antigo para evitar conflito com namespace do Gradle 8+
            sed -i 's/package="[^"]*"//g' app/src/main/AndroidManifest.xml
          fi
          
          # ===== GRADLE =====
          if [ -f "app/build.gradle.kts" ]; then
            sed -i "s/namespace = \".*\"/namespace = \"$PKG\"/g" app/build.gradle.kts
            sed -i "s/applicationId = \".*\"/applicationId = \"$PKG\"/g" app/build.gradle.kts
            sed -i "s/PACOTE_DINAMICO/$PKG/g" app/build.gradle.kts
          fi
          
          # ===== JAVA REORGANIZAÇÃO =====
          # Procura qualquer MainActivity.java no projeto e move para a pasta do novo package
          OLD_PATH=$(find app/src/main/java -name "MainActivity.java" | head -1)
          if [ ! -z "$OLD_PATH" ]; then
            mkdir -p "app/src/main/java/$PKG_PATH"
            mv "$OLD_PATH" "app/src/main/java/$PKG_PATH/MainActivity.java"
            sed -i "s/package .*/package $PKG;/" "app/src/main/java/$PKG_PATH/MainActivity.java"
            sed -i "s/PACOTE_DINAMICO/$PKG/g" "app/src/main/java/$PKG_PATH/MainActivity.java"
            # Limpa pastas vazias
            find app/src/main/java -type d -empty -delete
          fi
          
          # ===== PROGUARD =====
          if [ -f "app/proguard-rules.pro" ]; then
            sed -i "s/PACOTE_DINAMICO/$PKG/g" app/proguard-rules.pro
          fi

      - name: Configurar Keystore
        run: |
          cd app
          if [ -f "chave1.jks" ]; then
            echo "ORG_GRADLE_PROJECT_storeFile=chave1.jks" >> $GITHUB_ENV
          else
            keytool -genkeypair -v -keystore keystore.jks -alias androiddebugkey \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -storepass android -keypass android \
              -dname "CN=Android Debug, O=Android, C=US"
            echo "ORG_GRADLE_PROJECT_storeFile=keystore.jks" >> $GITHUB_ENV
          fi
          cd ..

      - name: Download e Aplicação do Ícone
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick webp || true
          
          ICON_URL="${{ github.event.client_payload.icon_url }}"
          if [ -n "$ICON_URL" ]; then
            curl -L -A "Mozilla/5.0" "$ICON_URL" -o /tmp/ic_launcher.webp || echo "Erro download"
          fi

          if [ ! -f /tmp/ic_launcher.webp ]; then
            convert -size 512x512 xc:#2196F3 /tmp/ic_launcher.webp
          fi
          
          for dir in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
            BASE="app/src/main/res/$dir"
            mkdir -p "$BASE"
            cp /tmp/ic_launcher.webp "$BASE/ic_launcher.webp"
            cp /tmp/ic_launcher.webp "$BASE/ic_launcher_round.webp"
          done

      - name: Extrair jogo (HTML/Construct)
        run: |
          mkdir -p app/src/main/assets/www
          rm -rf app/src/main/assets/www/*
          
          curl -L "${{ github.event.client_payload.zip_url }}" -o /tmp/jogo.zip
          
          if [ -s /tmp/jogo.zip ]; then
            unzip -q -o /tmp/jogo.zip -d app/src/main/assets/www/
            # Ajustar se o ZIP veio com uma pasta raiz
            if [ ! -f "app/src/main/assets/www/index.html" ]; then
               SUBFOLDER=$(find app/src/main/assets/www -name "index.html" -type f | xargs dirname | head -1)
               if [ -n "$SUBFOLDER" ] && [ "$SUBFOLDER" != "app/src/main/assets/www" ]; then
                  mv "$SUBFOLDER"/* app/src/main/assets/www/
               fi
            fi
          fi
          
          # Fallback se index.html não existir após extração
          if [ ! -f "app/src/main/assets/www/index.html" ]; then
            echo "<html><body style='background:#000;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh'><h1>Carregando...</h1></body></html>" > app/src/main/assets/www/index.html
          fi

      - name: Dar permissão ao Gradle Wrapper
        run: chmod +x gradlew

      - name: Compilar APK e AAB
        run: |
          ./gradlew clean
          ./gradlew assembleRelease --no-daemon
          ./gradlew bundleRelease --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: APK_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/apk/release/*.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: AAB_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/bundle/release/*.aab
