name: Fabrica SAAS
on:
  repository_dispatch:
    types: [build_event]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Configurar Keystore
        id: setup-keystore
        run: |
          echo "=== CONFIGURANDO KEYSTORE ==="
          
          # 1. Tenta usar o keystore do segredo
          if [ -n "${{ secrets.SIGNING_KEY_BASE64 }}" ]; then
            echo "Decodificando keystore do segredo..."
            echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 --decode > app/keystore.jks 2>/dev/null
            
            # Verifica se o arquivo n√£o est√° vazio
            if [ -s app/keystore.jks ]; then
              echo "‚úÖ Keystore do segredo carregado ($(stat -c%s app/keystore.jks) bytes)"
              
              # Testa se o keystore √© v√°lido
              if keytool -list -keystore app/keystore.jks -storepass "${{ secrets.KEY_PASSWORD }}" 2>&1 | grep -q "Alias name"; then
                echo "‚úÖ Keystore v√°lido e acess√≠vel"
                echo "key_source=secret" >> $GITHUB_ENV
              else
                echo "‚ùå Keystore inv√°lido ou senha incorreta"
                echo "key_source=invalid" >> $GITHUB_ENV
              fi
            else
              echo "‚ùå Keystore decodificado est√° vazio"
              echo "key_source=empty" >> $GITHUB_ENV
            fi
          else
            echo "‚ùå Segredo SIGNING_KEY_BASE64 n√£o definido"
            echo "key_source=missing" >> $GITHUB_ENV
          fi
          
          # 2. Se o keystore do segredo falhou, cria um keystore debug
          if [ "${{ env.key_source }}" != "secret" ]; then
            echo "Criando keystore debug para continuar o build..."
            keytool -genkeypair -v \
              -keystore app/keystore.jks \
              -alias androiddebugkey \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Android Debug, O=Android, C=US"
            
            echo "key_source=debug" >> $GITHUB_ENV
            echo "DEBUG_KEY_PASSWORD=android" >> $GITHUB_ENV
            echo "DEBUG_KEY_ALIAS=androiddebugkey" >> $GITHUB_ENV
          fi
          
          # Debug: Mostra informa√ß√µes finais
          echo "=== STATUS DO KEYSTORE ==="
          echo "Fonte da chave: ${{ env.key_source }}"
          ls -la app/keystore.jks 2>/dev/null || echo "Keystore n√£o encontrado"
      - name: Personalizar Projeto (SED)
        run: |
          echo "=== INICIANDO PERSONALIZA√á√ÉO ==="
          echo "App Name: ${{ github.event.client_payload.app_name }}"
          echo "Package: ${{ github.event.client_payload.package_name }}"
          echo "App ID: ${{ github.event.client_payload.app_id }}"
          
          # 1. Troca o Nome do App
          sed -i "s/NOME_DINAMICO/${{ github.event.client_payload.app_name }}/g" app/src/main/res/values/strings.xml
          
          # 2. Troca o Package no Manifest (Apenas no nome da Activity)
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/src/main/AndroidManifest.xml
          
          # 3. Troca o Package no Gradle (O que corrige o erro do AAB)
          sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/build.gradle.kts
          
          # 4. Troca o Package no c√≥digo Java
          if [ -f "app/src/main/java/com/meuapp/jogo/MainActivity.java" ]; then
            sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" app/src/main/java/com/meuapp/jogo/MainActivity.java
          fi
          
          # 5. Procura e substitui em todos os arquivos Java
          find app/src/main/java -name "*.java" -type f -exec sed -i "s/PACOTE_DINAMICO/${{ github.event.client_payload.package_name }}/g" {} \;
          
          # 6. Troca o Package no namespace do build.gradle.kts (crucial para AAB)
          sed -i "s/namespace = \"PACOTE_DINAMICO\"/namespace = \"${{ github.event.client_payload.package_name }}\"/g" app/build.gradle.kts
          
          # 7. Troca o applicationId no build.gradle.kts
          sed -i "s/applicationId = \"PACOTE_DINAMICO\"/applicationId = \"${{ github.event.client_payload.package_name }}\"/g" app/build.gradle.kts
          
          # Mostra o conte√∫do atualizado para debug
          echo "=== AndroidManifest.xml ap√≥s atualiza√ß√£o ==="
          head -30 app/src/main/AndroidManifest.xml
          
          echo "=== build.gradle.kts ap√≥s atualiza√ß√£o ==="
          head -40 app/build.gradle.kts
          
          echo "=== Verifica√ß√£o final do build.gradle ==="
          grep -E "(namespace|applicationId)" app/build.gradle.kts
      - name: Download e Troca do √çcone
        run: |
          echo "=== BAIXANDO √çCONE ==="
          echo "URL do √≠cone: ${{ github.event.client_payload.icon_url }}"
          
          # Tenta baixar o √≠cone
          curl -A "Mozilla/5.0" -L "${{ github.event.client_payload.icon_url }}" -o icone_usuario.png 2>/dev/null || echo "AVISO: N√£o foi poss√≠vel baixar o √≠cone"
          
          if [ -f icone_usuario.png ] && [ $(stat -c%s icone_usuario.png) -gt 100 ]; then
            echo "√çcone baixado com sucesso ($(stat -c%s icone_usuario.png) bytes). Aplicando..."
            find app/src/main/res/mipmap-* -name "ic_launcher.png" -exec cp icone_usuario.png {} \;
            find app/src/main/res/mipmap-* -name "ic_launcher_round.png" -exec cp icone_usuario.png {} \;
            echo "√çcone personalizado aplicado com sucesso!"
          else
            echo "Usando √≠cone padr√£o do template."
          fi
          
          echo "=== √çcones dispon√≠veis ==="
          find app/src/main/res -name "ic_launcher*.png" -exec ls -la {} \;
      - name: Limpar e Extrair Projeto do Jogo
        run: |
          echo "=== CONFIGURANDO JOGO ==="
          
          # 1. Garante que a pasta assets/www existe
          mkdir -p app/src/main/assets/www
          
          # 2. Limpa a pasta se j√° existir conte√∫do
          rm -rf app/src/main/assets/www/*
          
          # 3. Baixa o ZIP do jogo
          if [ -n "${{ github.event.client_payload.zip_url }}" ]; then
            echo "Baixando jogo da URL: ${{ github.event.client_payload.zip_url }}"
            curl -L "${{ github.event.client_payload.zip_url }}" -o jogo.zip 2>/dev/null || echo "Erro ao baixar ZIP"
          fi
          
          # 4. Extrai o ZIP se existir
          if [ -f "jogo.zip" ]; then
            echo "Extraindo conte√∫do do jogo..."
            unzip -o jogo.zip -d app/src/main/assets/www/ 2>/dev/null || echo "AVISO: Problema ao extrair ZIP"
            
            # 5. Verifica se o index.html foi extra√≠do
            if [ ! -f "app/src/main/assets/www/index.html" ]; then
              echo "Procurando arquivo principal..."
              # Encontra o primeiro arquivo HTML
              HTML_FILE=$(find app/src/main/assets/www -name "*.html" -o -name "*.htm" | head -1)
              
              if [ -n "$HTML_FILE" ]; then
                echo "Renomeando $HTML_FILE para index.html"
                mv "$HTML_FILE" app/src/main/assets/www/index.html
              else
                echo "Criando index.html padr√£o"
                echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Jogo</title></head><body><h1>Jogo Construct 3</h1><p>Conte√∫do carregado com sucesso.</p></body></html>' > app/src/main/assets/www/index.html
              fi
            fi
          else
            echo "Criando conte√∫do de exemplo"
            echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Jogo</title></head><body><h1>Meu Jogo</h1><p>Jogo constru√≠do com sucesso!</p></body></html>' > app/src/main/assets/www/index.html
          fi
          
          echo "=== ESTRUTURA DO JOGO ==="
          ls -la app/src/main/assets/www/
          echo "=== PRIMEIROS ARQUIVOS ==="
          find app/src/main/assets/www -type f | head -10
      - name: Dar permiss√£o ao Gradle
        run: chmod +x gradlew
      - name: Compilar APK e AAB (Release)
        run: |
          echo "=== INICIANDO COMPILA√á√ÉO ==="
          ./gradlew clean
          
          if [ "${{ env.key_source }}" = "secret" ]; then
            echo "üîê Compilando com keystore de produ√ß√£o..."
            ./gradlew assembleRelease bundleRelease \
              -PstorePassword="${{ secrets.KEY_PASSWORD }}" \
              -PkeyPassword="${{ secrets.KEY_PASSWORD }}" \
              -PkeyAlias="${{ secrets.ALIAS }}" \
              -PstoreFile=keystore.jks \
              --stacktrace --info
          else
            echo "üîì Compilando com keystore debug..."
            ./gradlew assembleRelease bundleRelease \
              -PstorePassword="android" \
              -PkeyPassword="android" \
              -PkeyAlias="androiddebugkey" \
              -PstoreFile=keystore.jks \
              --stacktrace --info
          fi
      - name: Verificar se os arquivos foram gerados
        run: |
          echo "=== VERIFICANDO ARQUIVOS GERADOS ==="
          
          echo "1. Procurando APKs..."
          find app/build/outputs -name "*.apk" 2>/dev/null | xargs ls -la || echo "Nenhum APK encontrado"
          
          echo "2. Procurando AABs..."
          find app/build/outputs -name "*.aab" 2>/dev/null | xargs ls -la || echo "Nenhum AAB encontrado"
          
          echo "3. Conte√∫do das pastas de release:"
          ls -la app/build/outputs/apk/release/ 2>/dev/null || echo "Pasta APK release n√£o existe"
          ls -la app/build/outputs/bundle/release/ 2>/dev/null || echo "Pasta AAB release n√£o existe"
      - name: Assinar Arquivos APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: app/build/outputs/apk/release/
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ env.DEBUG_KEY_ALIAS || secrets.ALIAS }}
          keyStorePassword: ${{ env.DEBUG_KEY_PASSWORD || secrets.KEY_PASSWORD }}
          keyPassword: ${{ env.DEBUG_KEY_PASSWORD || secrets.KEY_PASSWORD }}
        id: sign_app
        continue-on-error: true
      - name: Upload APK Assinado
        if: steps.sign_app.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: APK_${{ github.event.client_payload.app_id }}
          path: ${{ steps.sign_app.outputs.signedReleaseFile }}
          retention-days: 7
          if-no-files-found: warn
      - name: Upload APK N√£o Assinado (Fallback)
        if: steps.sign_app.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: APK_UNSIGNED_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/apk/release/*.apk
          retention-days: 7
          if-no-files-found: warn
      - name: Upload AAB para Play Store
        uses: actions/upload-artifact@v4
        with:
          name: AAB_${{ github.event.client_payload.app_id }}
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 7
          if-no-files-found: warn
      # Passo para notificar o sistema principal sobre a conclus√£o do build
      - name: Notificar Sistema Principal
        if: success() && github.event.client_payload.callback_url != ''
        run: |
          echo "=== ENVIANDO NOTIFICA√á√ÉO DE SUCESSO ==="
          
          # Obter nome do arquivo AAB
          AAB_FILE=$(ls app/build/outputs/bundle/release/*.aab 2>/dev/null | head -n1 | xargs basename 2>/dev/null || echo "app-release.aab")
          
          # Montar payload da notifica√ß√£o
          JSON_PAYLOAD=$(cat << EOF
          {
            "status": "success",
            "app_id": "${{ github.event.client_payload.app_id }}",
            "app_name": "${{ github.event.client_payload.app_name }}",
            "package_name": "${{ github.event.client_payload.package_name }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "repository": "${{ github.repository }}",
            "commit_sha": "${{ github.sha }}",
            "apk_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts?name=APK_${{ github.event.client_payload.app_id }}",
            "aab_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts?name=AAB_${{ github.event.client_payload.app_id }}",
            "logs_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "artifact_names": {
              "apk": "APK_${{ github.event.client_payload.app_id }}",
              "aab": "AAB_${{ github.event.client_payload.app_id }}"
            },
            "aab_filename": "$AAB_FILE"
          }
          EOF
          )
          
          echo "Payload: $JSON_PAYLOAD"
          echo "URL: ${{ github.event.client_payload.callback_url }}"
          
          # Enviar notifica√ß√£o (sem Authorization header)
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            --max-time 30 \
            --retry 2 \
            --retry-delay 5 \
            --fail-with-body \
            --silent \
            --output /dev/null \
            --write-out "Status: %{http_code}\n" || echo "AVISO: Falha ao enviar notifica√ß√£o de sucesso"
      # Passo para lidar com falhas
      - name: Notificar Falha
        if: failure() && github.event.client_payload.callback_url != ''
        run: |
          echo "=== ENVIANDO NOTIFICA√á√ÉO DE FALHA ==="
          
          # Montar payload da notifica√ß√£o de erro
          JSON_PAYLOAD=$(cat << EOF
          {
            "status": "error",
            "app_id": "${{ github.event.client_payload.app_id }}",
            "app_name": "${{ github.event.client_payload.app_name }}",
            "package_name": "${{ github.event.client_payload.package_name }}",
            "error": "Falha no processo de build - verifique os logs para detalhes",
            "logs_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "repository": "${{ github.repository }}",
            "commit_sha": "${{ github.sha }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          )
          
          echo "Payload de erro: $JSON_PAYLOAD"
          echo "URL: ${{ github.event.client_payload.callback_url }}"
          
          # Enviar notifica√ß√£o de erro (sem Authorization header)
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            --max-time 30 \
            --retry 2 \
            --retry-delay 5 \
            --fail-with-body \
            --silent \
            --output /dev/null \
            --write-out "Status: %{http_code}\n" || echo "AVISO: Falha ao enviar notifica√ß√£o de erro"
      - name: Limpeza Final
        if: always()
        run: |
          echo "=== LIMPEZA FINAL ==="
          echo "Removendo arquivos tempor√°rios..."
          rm -f jogo.zip icone_usuario.png game.zip icon.png 2>/dev/null || true
          echo "Build finalizado com status: ${{ job.status }}"
