name: W2A Builder

on:
  repository_dispatch:
    types: [build_event]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ORG_GRADLE_PROJECT_storePassword: ${{ secrets.KEY_PASSWORD || 'android' }}
      ORG_GRADLE_PROJECT_keyPassword: ${{ secrets.KEY_PASSWORD || 'android' }}
      ORG_GRADLE_PROJECT_keyAlias: ${{ secrets.ALIAS || 'androiddebugkey' }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Personalizar Projeto (Din√¢mico e Completo)
        run: |
          PKG="${{ github.event.client_payload.package_name }}"
          APP_NAME="${{ github.event.client_payload.app_name }}"
          PKG_PATH=$(echo "$PKG" | tr '.' '/')

          echo "=========================================="
          echo "INICIANDO PERSONALIZA√á√ÉO COMPLETA"
          echo "=========================================="

          # 1. STRINGS - Valida√ß√£o e Troca
          if [ -f "app/src/main/res/values/strings.xml" ]; then
            sed -i "s/NOME_DINAMICO/$APP_NAME/g" app/src/main/res/values/strings.xml
            echo "‚úì Strings atualizadas"
          else
            echo "ERROR: strings.xml n√£o encontrado" && exit 1
          fi

          # 2. MANIFEST - Corre√ß√£o de Namespace para AAB
          if [ -f "app/src/main/AndroidManifest.xml" ]; then
            # Remove o atributo package da tag manifest (Obrigat√≥rio para Gradle 8+)
            sed -i 's/package="[^"]*"//g' app/src/main/AndroidManifest.xml
            # Substitui placeholders internos
            sed -i "s/PACOTE_DINAMICO/$PKG/g" app/src/main/AndroidManifest.xml
            echo "‚úì Manifest atualizado"
          fi

          # 3. GRADLE - Ajuste de build.gradle.kts
          if [ -f "app/build.gradle.kts" ]; then
            sed -i "s/namespace = \".*\"/namespace = \"$PKG\"/g" app/build.gradle.kts
            sed -i "s/applicationId = \".*\"/applicationId = \"$PKG\"/g" app/build.gradle.kts
            sed -i "s/PACOTE_DINAMICO/$PKG/g" app/build.gradle.kts
            echo "‚úì Build.gradle.kts atualizado"
          fi

          # 4. JAVA - Reorganiza√ß√£o completa de pastas
          echo "Reorganizando estrutura Java..."
          # Localiza a MainActivity independente de onde ela esteja
          OLD_PATH=$(find app/src/main/java -name "MainActivity.java" | head -1)
          if [ -n "$OLD_PATH" ]; then
            mkdir -p "app/src/main/java/$PKG_PATH"
            mv "$OLD_PATH" "app/src/main/java/$PKG_PATH/MainActivity.java"
            sed -i "s/package .*/package $PKG;/" "app/src/main/java/$PKG_PATH/MainActivity.java"
            sed -i "s/PACOTE_DINAMICO/$PKG/g" "app/src/main/java/$PKG_PATH/MainActivity.java"
            # Remove pastas antigas que ficaram vazias
            find app/src/main/java -type d -empty -delete
            echo "‚úì Java reorganizado para $PKG"
          fi

          # 5. PROGUARD
          [ -f "app/proguard-rules.pro" ] && sed -i "s/PACOTE_DINAMICO/$PKG/g" app/proguard-rules.pro

      - name: Configurar Keystore
        run: |
          echo "=== CONFIGURANDO KEYSTORE ==="
          
          # Verifica se j√° tem chave1.jks no projeto
          if [ -f "app/chave1.jks" ]; then
            echo "‚úÖ Usando chave1.jks existente do projeto"
            # J√° est√° no lugar certo, n√£o precisa fazer nada
          else
            echo "‚ö† N√£o tem chave1.jks, verifica se tem SIGNING_KEY no GitHub"
            
            if [ -n "${{ secrets.SIGNING_KEY }}" ]; then
              echo "üîê Usando SIGNING_KEY do GitHub Secrets"
              echo "${{ secrets.SIGNING_KEY }}" | base64 --decode > app/chave1.jks
              echo "‚úÖ Keystore decodificado: app/chave1.jks"
            else
              echo "‚ö† N√£o tem keystore nenhum, criando debug.keystore"
              # Gera debug.keystore como fallback
              keytool -genkeypair -v \
                -keystore app/debug.keystore \
                -alias androiddebugkey \
                -keyalg RSA \
                -keysize 2048 \
                -validity 10000 \
                -storepass android \
                -keypass android \
                -dname "CN=Android Debug, O=Android, C=US"
              echo "‚úÖ debug.keystore gerado"
            fi
          fi
          
          # Verifica qual keystore est√° dispon√≠vel
          echo "Keystores dispon√≠veis:"
          ls -la app/*.jks app/*.keystore 2>/dev/null || echo "Nenhum keystore encontrado"

      - name: Download e Aplica√ß√£o do √çcone (Resistente a Erros)
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick webp || true
          ICON_URL="${{ github.event.client_payload.icon_url }}"
          
          if [ -n "$ICON_URL" ]; then
            curl -L -A "Mozilla/5.0" --connect-timeout 10 "$ICON_URL" -o /tmp/icon_raw || echo "Falha download"
          fi

          if [ -s /tmp/icon_raw ]; then
            convert /tmp/icon_raw -resize 512x512 /tmp/ic_launcher.webp || convert -size 512x512 xc:#2196F3 /tmp/ic_launcher.webp
          else
            convert -size 512x512 xc:#2196F3 /tmp/ic_launcher.webp
          fi

          for dir in mipmap-mdpi mipmap-hdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
            mkdir -p "app/src/main/res/$dir"
            cp /tmp/ic_launcher.webp "app/src/main/res/$dir/ic_launcher.webp"
            cp /tmp/ic_launcher.webp "app/src/main/res/$dir/ic_launcher_round.webp"
            # Remove PNGs antigos para n√£o dar conflito
            rm -f "app/src/main/res/$dir/ic_launcher.png" "app/src/main/res/$dir/ic_launcher_round.png"
          done

      - name: Extrair Assets do Jogo (Construct/HTML5)
        run: |
          mkdir -p app/src/main/assets/www
          rm -rf app/src/main/assets/www/*
          
          if [ -n "${{ github.event.client_payload.zip_url }}" ]; then
            curl -L "${{ github.event.client_payload.zip_url }}" -o /tmp/jogo.zip
            if [ -s /tmp/jogo.zip ]; then
              unzip -o /tmp/jogo.zip -d app/src/main/assets/www/
              # Move arquivos se estiverem dentro de uma subpasta no ZIP
              if [ ! -f "app/src/main/assets/www/index.html" ]; then
                SEARCH_INDEX=$(find app/src/main/assets/www -name "index.html" | head -1)
                if [ -n "$SEARCH_INDEX" ]; then
                  mv $(dirname "$SEARCH_INDEX")/* app/src/main/assets/www/
                fi
              fi
            fi
          fi

          if [ ! -f "app/src/main/assets/www/index.html" ]; then
            echo "<html><body style='background:#000;color:#fff'><h1>Carregando...</h1></body></html>" > app/src/main/assets/www/index.html
          fi

      - name: Preparar Gradle
        run: |
          chmod +x gradlew
          echo "=== DEBUG: Verificando configura√ß√£o ==="
          echo "App chave1.jks existe? $(ls -la app/chave1.jks 2>/dev/null && echo 'SIM' || echo 'N√ÉO')"
          echo "App debug.keystore existe? $(ls -la app/debug.keystore 2>/dev/null && echo 'SIM' || echo 'N√ÉO')"

      - name: Compilar APK e AAB (Release)
        run: |
          echo "=== COMPILANDO ==="
          
          echo "Estrutura do app/build.gradle.kts:"
          grep -n "signingConfigs\|buildTypes" app/build.gradle.kts || true
          
          ./gradlew clean
          
          echo "Construindo APK..."
          ./gradlew assembleRelease --no-daemon --stacktrace
          
          echo "Construindo AAB..."
          ./gradlew bundleRelease --no-daemon --stacktrace
          
          echo "=== BUILD COMPLETO ==="
          echo "APKs gerados:"
          find app/build/outputs/apk -name "*.apk" -type f | xargs ls -la
          echo "AABs gerados:"
          find app/build/outputs/bundle -name "*.aab" -type f | xargs ls -la

      - name: Upload dos Artefatos
        id: upload-artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build_${{ github.event.client_payload.app_id }}
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
          retention-days: 7

      - name: Gerar Links de Download
        id: generate-links
        if: success()
        run: |
          echo "=== GERANDO LINKS DE DOWNLOAD ==="
          
          APP_ID="${{ github.event.client_payload.app_id }}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          
          # Link direto para a p√°gina espec√≠fica do run (com artifacts)
          RUN_URL="https://github.com/$REPO/actions/runs/$RUN_ID"
          
          # Link para o ZIP do artefato (via nightly.link)
          ARTIFACT_NAME="Build_$APP_ID"
          DOWNLOAD_URL="https://nightly.link/$REPO/actions/runs/$RUN_ID/$ARTIFACT_NAME.zip"
          
          # Links individuais (opcional)
          APK_DOWNLOAD_URL="https://nightly.link/$REPO/actions/runs/$RUN_ID/APK_$APP_ID.zip"
          AAB_DOWNLOAD_URL="https://nightly.link/$REPO/actions/runs/$RUN_ID/AAB_$APP_ID.zip"
          
          echo "üì¶ Nome do Artefato: $ARTIFACT_NAME"
          echo "üîó URL do Run: $RUN_URL"
          echo "üì• URL de Download: $DOWNLOAD_URL"
          echo "üì± URL APK: $APK_DOWNLOAD_URL"
          echo "üì¶ URL AAB: $AAB_DOWNLOAD_URL"
          
          # Salvar URLs como outputs
          echo "run_url=$RUN_URL" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "apk_url=$APK_DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "aab_url=$AAB_DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Enviar Callback de Sucesso
        if: success() && steps.upload-artifacts.outcome == 'success'
        run: |
          echo "=== ENVIANDO CALLBACK DE SUCESSO ==="
          
          APP_ID="${{ github.event.client_payload.app_id }}"
          CALLBACK_URL="${{ github.event.client_payload.callback_url }}"
          
          if [ -n "$CALLBACK_URL" ] && [ -n "$APP_ID" ]; then
            echo "üì§ URL do Callback: $CALLBACK_URL"
            
            # Usar URLs geradas no passo anterior
            RUN_URL="${{ steps.generate-links.outputs.run_url }}"
            DOWNLOAD_URL="${{ steps.generate-links.outputs.download_url }}"
            APK_URL="${{ steps.generate-links.outputs.apk_url }}"
            AAB_URL="${{ steps.generate-links.outputs.aab_url }}"
            ARTIFACT_NAME="${{ steps.generate-links.outputs.artifact_name }}"
            
            REPO="${{ github.repository }}"
            RUN_ID="${{ github.run_id }}"
            
            # Payload completo
            PAYLOAD=$(cat << EOF
{
  "app_id": "$APP_ID",
  "status": "success",
  "message": "Build conclu√≠do com sucesso!",
  "run_id": "$RUN_ID",
  "run_url": "$RUN_URL",
  "repository": "$REPO",
  "download_url": "$DOWNLOAD_URL",
  "apk_url": "$APK_URL",
  "aab_url": "$AAB_URL",
  "artifact_name": "$ARTIFACT_NAME",
  "build_time": "$(date -Iseconds)",
  "workflow": "${{ github.workflow }}"
}
EOF
            )
            
            echo "üì¶ Payload a ser enviado:"
            echo "$PAYLOAD"
            
            # Enviar callback com timeout e retry
            for i in {1..3}; do
              echo "üîÑ Tentativa $i/3..."
              
              HTTP_CODE=$(curl -X POST "$CALLBACK_URL" \
                -H "Content-Type: application/json" \
                -H "User-Agent: GitHub-Actions-W2A-Builder" \
                -d "$PAYLOAD" \
                --max-time 30 \
                --retry 2 \
                --retry-delay 5 \
                --write-out "%{http_code}" \
                --silent --show-error \
                --output /tmp/curl_response.txt)
              
              RESPONSE=$(cat /tmp/curl_response.txt)
              echo "üì° Resposta ($i): HTTP $HTTP_CODE"
              
              if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
                echo "‚úÖ Callback enviado com sucesso!"
                break
              else
                echo "‚ö†Ô∏è Falha HTTP $HTTP_CODE"
                if [ $i -lt 3 ]; then
                  echo "‚è≥ Aguardando 5 segundos..."
                  sleep 5
                else
                  echo "‚ùå Todas as tentativas falharam"
                  echo "üìù Links dispon√≠veis (usu√°rio pode acessar manualmente):"
                  echo "   üîó Run: $RUN_URL"
                  echo "   üì• Download: $DOWNLOAD_URL"
                fi
              fi
            done
          else
            echo "‚ö†Ô∏è Sem URL de callback configurada"
            echo "üìù Links do build:"
            echo "   üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

      - name: Enviar Callback de Falha
        if: failure()
        run: |
          echo "=== ENVIANDO CALLBACK DE FALHA ==="
          
          APP_ID="${{ github.event.client_payload.app_id }}"
          CALLBACK_URL="${{ github.event.client_payload.callback_url }}"
          
          if [ -n "$CALLBACK_URL" ] && [ -n "$APP_ID" ]; then
            echo "üì§ URL do Callback: $CALLBACK_URL"
            
            REPO="${{ github.repository }}"
            RUN_ID="${{ github.run_id }}"
            RUN_URL="https://github.com/$REPO/actions/runs/$RUN_ID"
            
            PAYLOAD=$(cat << EOF
{
  "app_id": "$APP_ID",
  "status": "failure",
  "message": "Build falhou. Verifique os logs para mais detalhes.",
  "run_id": "$RUN_ID",
  "run_url": "$RUN_URL",
  "repository": "$REPO",
  "build_time": "$(date -Iseconds)",
  "workflow": "${{ github.workflow }}"
}
EOF
            )
            
            echo "üì¶ Payload a ser enviado:"
            echo "$PAYLOAD"
            
            # Enviar callback (apenas 1 tentativa para falhas)
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -H "User-Agent: GitHub-Actions-W2A-Builder" \
              -d "$PAYLOAD" \
              --max-time 30 \
              --silent --show-error \
              && echo "‚úÖ Callback de falha enviado" \
              || echo "‚ö†Ô∏è Callback de falha n√£o enviado"
          else
            echo "‚ö†Ô∏è Sem URL de callback configurada"
          fi
